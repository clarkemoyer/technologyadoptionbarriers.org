name: Prolific Survey Data Collection

on:
  # Run on schedule (every Monday at 9 AM UTC)
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      study_id:
        description: 'Specific Study ID to query (optional - leave blank to list all studies)'
        required: false
        type: string

# Prevent concurrent runs
concurrency:
  group: 'prolific-data-collection'
  cancel-in-progress: false

# Explicit permissions for GITHUB_TOKEN
permissions:
  contents: read

jobs:
  collect-survey-data:
    name: Collect Prolific Survey Data
    runs-on: ubuntu-latest
    environment: prolific-prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Prolific API token
        run: |
          if [ -z "${{ secrets.TABS_PROLIFIC_TOKEN }}" ]; then
            echo "Error: TABS_PROLIFIC_TOKEN secret is not set in the prolific-prod environment"
            exit 1
          fi
          echo "✅ Prolific API token is configured"

      - name: Run data collection
        env:
          PROLIFIC_API_TOKEN: ${{ secrets.TABS_PROLIFIC_TOKEN }}
          STUDY_ID: ${{ inputs.study_id || vars.PROLIFIC_STUDY_ID }}
        run: |
          echo "Starting Prolific data collection..."
          echo "Study ID: ${STUDY_ID:-'all studies'}"
          echo ""
          npx --no-install tsx scripts/collect-prolific-data.ts

      - name: Error summary
        if: failure()
        run: |
          echo "### ❌ Prolific Data Collection Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "An error occurred while collecting data from the Prolific API." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the job logs above for error details." >> $GITHUB_STEP_SUMMARY
