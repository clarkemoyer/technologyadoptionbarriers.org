name: Update Qualtrics Survey Metrics

on:
  workflow_dispatch:
    inputs:
      survey_id:
        description: 'Optional Survey ID (defaults to QUALTRICS_SURVEY_ID env var, else first survey returned by /surveys)'
        required: false
        type: string
  schedule:
    - cron: '17 3 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    environment: qualtrics-prod
    env:
      QUALTRICS_API_TOKEN: ${{ secrets.QUALTRICS_API_TOKEN }}
      QUALTRICS_BASE_URL: ${{ vars.QUALTRICS_BASE_URL }}
      QUALTRICS_SURVEY_ID: ${{ vars.QUALTRICS_SURVEY_ID }}
      INPUT_SURVEY_ID: ${{ inputs.survey_id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Fetch metrics from Qualtrics
        shell: bash
        run: |
          set -euo pipefail

          TMP_DIR="${RUNNER_TEMP:-/tmp}"
          SURVEYS_JSON="$TMP_DIR/qualtrics-surveys.json"
          SURVEY_JSON="$TMP_DIR/qualtrics-survey.json"

          if [[ -z "${QUALTRICS_API_TOKEN:-}" ]]; then
            echo "Missing secret QUALTRICS_API_TOKEN in environment qualtrics-prod"
            exit 1
          fi

          if [[ -z "${QUALTRICS_BASE_URL:-}" ]]; then
            echo "Missing env var QUALTRICS_BASE_URL in environment qualtrics-prod"
            exit 1
          fi

          BASE_URL="${QUALTRICS_BASE_URL%/}"
          SURVEY_ID="${INPUT_SURVEY_ID:-${QUALTRICS_SURVEY_ID:-}}"

          if [[ -z "${SURVEY_ID}" ]]; then
            url="${BASE_URL}/API/v3/surveys"
            http_code=$(curl -sS -o "$SURVEYS_JSON" -w "%{http_code}" \
              -H "X-API-TOKEN: ${QUALTRICS_API_TOKEN}" \
              -H "Accept: application/json" \
              "$url")

            if [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
              echo "Request failed (HTTP $http_code): $url"
              head -c 4000 "$SURVEYS_JSON" || true
              exit 1
            fi

            SURVEY_ID=$(jq -r '.result.elements[0].id // empty' "$SURVEYS_JSON")
            if [[ -z "$SURVEY_ID" ]]; then
              echo "Could not auto-select a survey id from /surveys. Set QUALTRICS_SURVEY_ID or pass workflow input survey_id."
              exit 1
            fi
          fi

          url="${BASE_URL}/API/v3/surveys/${SURVEY_ID}"
          http_code=$(curl -sS -o "$SURVEY_JSON" -w "%{http_code}" \
            -H "X-API-TOKEN: ${QUALTRICS_API_TOKEN}" \
            -H "Accept: application/json" \
            "$url")

          if [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
            echo "Request failed (HTTP $http_code): $url"
            head -c 4000 "$SURVEY_JSON" || true
            exit 1
          fi

          collected_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          survey_name=$(jq -r '.result.name // ""' "$SURVEY_JSON")
          org_id=$(jq -r '.result.organizationId // ""' "$SURVEY_JSON")
          response_counts=$(jq -c '.result.responseCounts // {}' "$SURVEY_JSON")

          mkdir -p src/data
          jq -n \
            --arg collectedAt "$collected_at" \
            --arg baseUrl "$BASE_URL" \
            --arg surveyId "$SURVEY_ID" \
            --arg surveyName "$survey_name" \
            --arg orgId "$org_id" \
            --argjson responseCounts "$response_counts" \
            '{
              collectedAt: $collectedAt,
              baseUrl: $baseUrl,
              survey: {
                id: $surveyId,
                name: $surveyName,
                organizationId: $orgId
              },
              responseCounts: $responseCounts,
              metrics: ($responseCounts | to_entries | map({metric: .key, value: .value}) | sort_by(.metric))
            }' > temp-qualtrics-metrics.json

          # --- VALIDATION STEP ---
          echo "Validating new metrics..."

          # 1. Check if valid JSON
          if ! jq -e . temp-qualtrics-metrics.json >/dev/null; then
            echo "::error::Generated file is invalid JSON."
            exit 1
          fi

          # 2. Check for empty metrics
          metric_count=$(jq '.metrics | length' temp-qualtrics-metrics.json)
          if [[ "$metric_count" -eq 0 ]]; then
            echo "::error::No metrics found in response."
            exit 1
          fi

          # 3. Check for regression (Total responses should not decrease)
          if [[ -f "src/data/qualtrics-metrics.json" ]]; then
            old_count=$(jq '.responseCounts | to_entries | map(.value) | add // 0' src/data/qualtrics-metrics.json)
            new_count=$(jq '.responseCounts | to_entries | map(.value) | add // 0' temp-qualtrics-metrics.json)
            
            echo "Total Responses: Old=$old_count, New=$new_count"
            
            if [[ "$new_count" -lt "$old_count" ]]; then
              echo "::error::Regression detected: New response count ($new_count) is lower than existing count ($old_count)."
              exit 1
            fi
          fi

          # If we got here, validation passed. Move file to final location.
          mv temp-qualtrics-metrics.json src/data/qualtrics-metrics.json
          echo "Validation passed. File updated."

      - name: Create pull request with updated metrics
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: 'Update Qualtrics survey metrics'
          title: 'Update Qualtrics survey metrics'
          body: |
            Automated update of `src/data/qualtrics-metrics.json` from the Qualtrics API.

            Each response count type is stored as its own metric for charting.

            **Validation Passed:**
            - JSON Integrity Verified.
            - Metrics Data Present.
            - No Regression in Total Response Counts.
          branch: chore/qualtrics-metrics
          delete-branch: true

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.created == 'true'
        run: gh pr merge --auto --merge "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
