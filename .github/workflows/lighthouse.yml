name: Lighthouse CI

on:
  # Run after deployment workflow completes on main branch
  workflow_run:
    workflows: ['Deploy to GitHub Pages']
    types:
      - completed
    branches: ['main']

  # Run on pull requests
  pull_request:
    branches: ['main']

  # Allow manual trigger
  workflow_dispatch:

# Only run if the deployment was successful
jobs:
  lighthouse:
    # Only run on successful deployment, PR, or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build
        env:
          NEXT_PUBLIC_BASE_PATH: /FFC_Single_Page_Template

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Display Lighthouse Results Summary
        if: always()
        run: |
          echo "üìä Lighthouse CI Results Summary"
          echo "=================================="

          if [ ! -d ".lighthouseci" ]; then
            echo "‚ùå No Lighthouse results directory found"
            echo "This step will not fail the workflow."
            exit 0
          fi

          # Find all JSON reports
          json_files=$(find .lighthouseci -name "lhr-*.json" | sort)

          if [ -z "$json_files" ]; then
            echo "‚ùå No Lighthouse JSON reports found"
            echo "This step will not fail the workflow."
            exit 0
          fi

          echo "Found $(echo "$json_files" | wc -l) report files"
          echo ""

          # Install jq if not available
          which jq > /dev/null || (sudo apt-get update && sudo apt-get install -y jq)

          # Process each unique URL
          urls=$(echo "$json_files" | xargs -I {} jq -r '.requestedUrl // .finalDisplayedUrl' {} | sort -u)

          for url in $urls; do
            page_name=$(echo "$url" | sed 's|http://localhost:[0-9]*/||' | sed 's|/index.html||' | sed 's|/$||')
            if [ -z "$page_name" ]; then
              page_name="Home"
            fi
            
            echo "üìÑ Page: $page_name"
            echo "   URL: $url"
            
            # Extract scores from all reports for this URL
            for report_file in $json_files; do
              # Check if this report matches the current URL
              report_url=$(jq -r '.requestedUrl // .finalDisplayedUrl' "$report_file" 2>/dev/null || echo "")
              if [ "$report_url" != "$url" ]; then
                continue
              fi
              if [ -f "$report_file" ]; then
                perf=$(jq -r '.categories.performance.score * 100 | round' "$report_file" 2>/dev/null || echo "N/A")
                acc=$(jq -r '.categories.accessibility.score * 100 | round' "$report_file" 2>/dev/null || echo "N/A")
                bp=$(jq -r '.categories["best-practices"].score * 100 | round' "$report_file" 2>/dev/null || echo "N/A")
                seo=$(jq -r '.categories.seo.score * 100 | round' "$report_file" 2>/dev/null || echo "N/A")
                
                echo "   Run: Performance: ${perf}% | Accessibility: ${acc}% | Best Practices: ${bp}% | SEO: ${seo}%"
              fi
            done
            echo ""
          done

          echo "‚úÖ Lighthouse CI completed successfully"
          echo "üì• Full reports available in workflow artifacts"

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci
          retention-days: 30

      - name: Comment PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            async function run() {
            const fs = require('fs');
            const path = require('path');

            // Read Lighthouse results
            const resultsDir = '.lighthouseci';
            if (!fs.existsSync(resultsDir)) {
              console.log('No Lighthouse results found');
              return;
            }

            // Find all JSON report files
            const files = fs.readdirSync(resultsDir).filter(f => f.endsWith('.json'));
            if (files.length === 0) {
              console.log('No Lighthouse JSON reports found');
              return;
            }

            // Parse all reports and organize by URL
            const reportsByUrl = {};
            for (const file of files) {
              const filePath = path.join(resultsDir, file);
              const report = JSON.parse(fs.readFileSync(filePath, 'utf8'));
              const url = report.requestedUrl || report.finalDisplayedUrl;
              
              if (!reportsByUrl[url]) {
                reportsByUrl[url] = [];
              }
              reportsByUrl[url].push(report);
            }

            // Helper function to get median score
            function getMedianScore(scores) {
              const sorted = [...scores].sort((a, b) => a - b);
              const mid = Math.floor(sorted.length / 2);
              return sorted.length % 2 === 0 
                ? (sorted[mid - 1] + sorted[mid]) / 2 
                : sorted[mid];
            }

            // Helper function to get score emoji and status
            function getScoreDisplay(score) {
              const percentage = Math.round(score * 100);
              if (percentage >= 90) return { emoji: 'üü¢', status: 'Good' };
              if (percentage >= 50) return { emoji: 'üü°', status: 'Needs Improvement' };
              return { emoji: 'üî¥', status: 'Poor' };
            }

            // Thresholds from lighthouserc.json
            const thresholds = {
              performance: 0.55,
              accessibility: 0.9,
              'best-practices': 0.65,
              seo: 0.95
            };

            // Create comment header
            let comment = '## üî¶ Lighthouse CI Results\n\n';
            comment += `**Pages Audited**: ${Object.keys(reportsByUrl).length} | `;
            comment += `**Runs Per Page**: 3 (showing median scores)\n\n`;

            // Process each URL
            let allPassed = true;
            for (const [url, reports] of Object.entries(reportsByUrl)) {
              let urlPath, pageName;
              try {
                urlPath = new URL(url).pathname;
                pageName = urlPath === '/' || urlPath === '/index.html' 
                  ? 'Home' 
                  : urlPath.replace('/index.html', '').replace(/\//g, ' ').trim();
              } catch (error) {
                console.error(`Error processing URL ${url}:`, error);
                continue; // Skip this URL
              }
              
              comment += `### üìÑ ${pageName}\n\n`;
              comment += '| Category | Score | Status | Threshold |\n';
              comment += '|----------|-------|--------|----------|\n';

              const categories = ['performance', 'accessibility', 'best-practices', 'seo'];
              
              for (const category of categories) {
                const scores = reports.map(r => r.categories[category]?.score ?? 0);
                const medianScore = getMedianScore(scores);
                const percentage = Math.round(medianScore * 100);
                const display = getScoreDisplay(medianScore);
                const threshold = Math.round((thresholds[category] || 0) * 100);
                const passed = medianScore >= (thresholds[category] || 0);
                
                if (!passed) allPassed = false;
                
                const categoryName = category.split('-').map(w => 
                  w.charAt(0).toUpperCase() + w.slice(1)
                ).join(' ');
                
                const passIcon = passed ? '‚úÖ' : '‚ö†Ô∏è';
                comment += `| ${display.emoji} ${categoryName} | **${percentage}%** | ${display.status} ${passIcon} | ‚â•${threshold}% |\n`;
              }
              
              comment += '\n';
            }

            // Add summary
            comment += '---\n\n';
            if (allPassed) {
              comment += '‚úÖ **All categories meet or exceed the configured thresholds!**\n\n';
            } else {
              comment += '‚ö†Ô∏è **Some categories are below the configured thresholds.**\n\n';
              comment += 'Categories below threshold are marked with ‚ö†Ô∏è. These are warning levels, not failures.\n\n';
            }

            // Add helpful links
            comment += '**Legend:**\n';
            comment += '- üü¢ **Good** (90-100%): Excellent performance\n';
            comment += '- üü° **Needs Improvement** (50-89%): Some issues to address\n';
            comment += '- üî¥ **Poor** (0-49%): Significant problems\n\n';
            comment += '**Thresholds:**\n';
            comment += '- Performance: ‚â•55% (warn)\n';
            comment += '- Accessibility: ‚â•90% (warn)\n';
            comment += '- Best Practices: ‚â•65% (warn)\n';
            comment += '- SEO: ‚â•95% (warn)\n\n';
            comment += 'üì• Download the detailed HTML reports from the [workflow artifacts](';
            comment += `${context.payload.repository.html_url}/actions/runs/${context.runId}) for in-depth analysis.\n\n`;
            comment += 'üìñ Learn more about [Lighthouse scoring](https://developer.chrome.com/docs/lighthouse/performance/performance-scoring/)';

            // Post comment on PR
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            console.log('Lighthouse results comment posted successfully');
            }

            await run();
